<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rotta del Tesoro · Avvio</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <section class="panel" style="width:min(920px,96vw);">
    <div class="panelInner">
      <div class="title">
        <h2>Registrazione del Capitano</h2>
        <small>“Una rotta senza nome finisce sugli scogli.”</small>
      </div>
      <div class="hr"></div>

      <div class="statusBox">
        <div class="statusLine" id="msg">Sto incidendo il tuo Codice Capitano…</div>
        <div class="muted" id="code" style="margin-top:10px;"></div>

        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn primary" id="copy" style="display:none;">Copia codice</button>
          <a class="btn ghost" href="./index.html" id="go" style="display:none;">Entra nella rotta</a>
        </div>

        <div class="foot" style="margin-top:10px;">
          Se cambi telefono: vai su Ripristina e inserisci questo codice.
        </div>
      </div>
    </div>
  </section>

  <script>
    const msg = document.getElementById("msg");
    const code = document.getElementById("code");
    const copyBtn = document.getElementById("copy");
    const goBtn = document.getElementById("go");
    let playerId = "";

    async function go(){
      const r = await fetch("/api/start", { method:"POST", credentials:"include" });
      const j = await r.json();
      if(!j.ok){
        msg.textContent = "Errore avvio.";
        code.textContent = j.error || "Sconosciuto";
        return;
      }
      playerId = j.playerId;
      msg.textContent = "Codice Capitano creato ✅";
      code.innerHTML = `<div style="font-size:22px; font-weight:1000; letter-spacing:.06em;">${playerId}</div>`;
      copyBtn.style.display = "inline-flex";
      goBtn.style.display = "inline-flex";
    }

    copyBtn.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(playerId);
        copyBtn.textContent = "Copiato ✅";
        setTimeout(()=> copyBtn.textContent = "Copia codice", 1200);
      }catch{
        copyBtn.textContent = "Copia manualmente";
      }
    });

    go();
  </script>
</body>
</html>
